# IMApp_Account（IM会計）

新居雅行 (nii@msyk.net)

[![en](https://img.shields.io/badge/lang-en-red.svg)](https://github.com/msyk/IMApp_Account/blob/master/README.en.md)

主に個人事業主をターゲットとした会計アプリケーション。INTER-Mediatorで開発しました。正式名称はまだ決めていませんが、「IM会計」と呼んでください。

## 2022年スタートした電子帳簿保存法に対応

この会計アプリケーションは作成者の新居が自身で必要な用途に向けて作ったものであって、特定の方向けに作ったものではありません。2022年1月1日にスタートした令和3年度税制改正では、国税関係帳簿書類の電子保存手続について、簡素化の観点から大幅な見直しが行われました。これにより、帳簿書類の電子保存が個人事業主など小規模な事業主にも簡単にできるようになりましたが、そのためのシステムを独自に準備するのはとてもハードルの高いものでした。

今回の改正電子帳簿保存法（電帳法）では、紙で受領した書類のスキャナ保存等の要件が大幅に緩和された一方で、電子取引については紙出力による保存が認められなくなるなど、多くの事業者にはインパクトの大きいものでした。これら要件を当システムではクリアできるようにさまざまな工夫を加えました。特に帳票の登録や修正・追加が行われた場合にはその内容と履歴が改変されないようシステムを用意する必要がありますがこの「IM会計」（仮称）はAmazonが提供するクラウド、AWS上に帳票を保存するようにして電帳法の求める要件をクリアしています。

全ソースを公開していますので、自由に改変して使っていただいて構いません。機能についての要望があればもちろんお伺いしますが、自分で便利であると思ったものは実装するかもしれませんが、そうでないものは実装しないかもしれません。もし、ご自分用に改造して欲しいという場合は、原則として請負業務としてお引き受けすることはやぶさかではありません。

## 動作するための準備
PHP、git、composer、SQLite、Node.jsが稼働するようにしておいてください。必要なら、Apache等Webアプリケーションも用意してください。
私は普段はMacしか使っていません。この記事は基本的にMac上で動作させる手順をまとめています。Macは「純正Unix」であることから、このシステムはLinux上でも同様に動きます。

最新のM1チップ（Apple silicon）を搭載したMac上各種開発ツールをインストールするならHomebrew（注１）を使うのが便利で確実です。また、データベースシステムのSQLiteはmacOSに最初から装備されていますので、新たにインストールする必要はありません。PHPは2022年３月17日現在、既に安定版の8.0.17が配布されていますので、
```
$ brew install php@8.0
```
を実行してPHP 8系列をインストールしておいてください。

Windows OSに関しては、この手順通りに同様な操作をすればWindows Subsystem for Linux (WSL)上でのインストールと稼働が可能なことは確認しました。

## セットアップ
このアプリケーションはcomposerによってセットアップされます。まず、レポジトリをご自分のローカルマシン内の適当なフォルダにクローンしてください。
```
git clone https://github.com/msyk/IMApp_Account
cd IMApp_Account
```

これでIMApp_Accountディレクトリ内に移動していますので、以下のようにcomposerコマンドを実行します。
```
composer install
```
初めてインストールする場合には必要な環境をかき集め、構築しますので数分間かかります。

独自のレポジトリにこのアプリケーションを収めたいなら、GitHubのテンプレートレポジトリの機能を利用できます。そうすれば、プライベートなレポジトリにアプリケーションや場合によってはバックアップデータを保持できます。


## アプリケーションの開始
アプリケーションを開始する簡単な方法は、phpのサーバモードを使うのが良いでしょう。
```
php -S localhost:9000
```
コマンド入力後、同じMac/PC等のブラウザで「 http://localhost:9000/ 」を開くと、アプリケーションにアクセスできます。

## Setup for S3

続いてAmazonのクラウドサービスAWS内に構築するストレージ「S3」に請求書・納品書・領収書などの関連帳票類を収める仕組みを構築します。（注１）

まず最初にS3側にIAMサービスでS3のフルアクセス機能を持ったユーザを作っておく必要があります。続いて、帳票のファイルデータを保存するためのバケットを用意します。バケット名はprivateディレクトリ内に作るaws_settings.phpというファイル内で指定する ```$rootBucket``` と同じものを設定してください。

詳細は、privateディレクトリにあるREADME.mdファイルを読んでください。このディレクトリに、S3のアカウント情報などを保存した ```aws_settings.php``` というファイルを作ります。

## Database Operations

```composer install```コマンドを実行すれば、データベースファイルがホーム直下の.im_dbディレクトリ内に作られ、スキーマが適用されます。もし、そのファイルが既に存在すれば、コマンド内で上書きするかそのままにするかを選択できます。

```composer db-backup```コマンドを実行すれば、現状のデータベースファイルをレポジトリのdb-backupディレクトリにコピーします。ファイル名にはタイムスタンプの文字列が追加されます。

```composer db-restore```コマンドを実行すれば、db-backupディレクトリにある一番新しいファイルを.im_dbディレクトリにコピーします。

```composer update```コマンドを実行すれば、INTER-Mediatorを含むPHPやJavaScriptのライブラリを更新します。

# 独自のレポジトリでの運用

このレポジトリはパブリックなので、当然ながらセンシティブな情報はここにはアップロードできません。このレポジトリがプライベートであることで問題が解決するなら、GitHubのテンプレート機能を使ってみましょう。プライベートなレポジトリであれば、もしあなたが気にしないのであれば、プライベートな情報を保持できます。例えば、データのバックアップや独自のページを追加できます。一方、そのようにすると、オリジナルのレポジトリは切り離され、オリジナルのレポジトリへの更新結果を反映させるのは難しくなります。

- プライベートなレポジトリを作成するには、このレポジトリのトップページにある「Use this Template」をクリックして、レポジトリを作ります。
- 作ったレポジトリを、クローンして利用してください。
- ```composer db-backup```や```composer db-restore```コマンドにより、レポジトリ内にデータのバックアップを作成したり、リストアができます。
- 具体的な手順についてはprivateディレクトリのREADME.mdファイルをご覧ください。
- 作成したファイルなどをレポジトリ側に反映させるために、.gitignoreファイルから、 「db-backup」「private/*.sql」「private/*.php」の記述を削除してください。

レポジトリにプライベートな情報を保存するのは安全でしょうか？　この問いへの回答は確かに難しいのですが、少なくとも管理の甘いオンプレミスなサーバよりよほど安全ではないでしょうか。

---
注１）Macに各種開発ツールをインストールするにはHomebrewという仕組みを使うのが便利で確実です。 https://brew.sh/index_ja にアクセスすると日本語の本家ページが開きます。そこに書かれた１行のインストールコマンドをコピーしてターミナルにペーストするだけでHomebrewが実行可能になります。このページにはさまざまな有益な情報が満載ですので、探索してみてください。

注２）S3はクラウド上にファイル保存できる仕組みで、税務書類など長期間に渡って参照されることなく保存しておくだけといった利用形態ならきわめて低料金で利用できます。青色申告に使った帳票類は７年間、法人の場合は帳票によって10年間の保存義務がありますが、その間ほとんどダウンロードして表示させることはありません。こうした利用形態にはうってつけの仕組みです。改正電子帳簿保存法ではタイムスタンプの付与などに関して大幅に条件が緩和されましたが、緩和の条件としてクラウド上に保存した帳票の追加や訂正などが生じた時にその履歴が記録されるシステムであることという要件が加わりました。S3はそうした操作記録がすべて残される上に、訂正する前のファイルも復元してダウンロードできます。これらの機能により、立入り税務調査などの場合にも対応できるシステムを構築することができるわけです。

## 謝辞

- haya-san ドキュメントの監修ありがとうございます。
